---
layout: post
title: 'nginx 사용법'
author: kundol
comments: true
date: 2019-05-16 07:00
tags: [web, nginx]

---   
 > You just may be hacked when some yet-unknown buffer overflow is discovered. Not that that couldn't happen behind nginx, but somehow having a proxy in front makes me happy

node.js를 만든 라이언달이 말했습니다. 아직 발견되지 않은 버포 오버플로우 취약점에 의해 해킹당할 수 있으니 nginx를 proxy서버 앞단에 두는 것이 좋다고 생각한다는 말입니다. 
즉, 실제포트를 숨기고 nginx의 80포트를 통해서 프록시하면 보안적으로 막을 수 있다는 것인데 이것 말고도 정적자료에 대한 gzip압축, 그리고 앞단에서의 로그를 저장할 수 있습니다. 이것보다 더 많은 기능이 있지만 제가 사용했던 것만 적어 놓습니다.  

## nginx 구조 
nginx는 블록단위의 구조를 가지고 있습니다. 
```shell
error_log  /var/log/nginx_errors.log warn;

events { 
    worker_connections  1024;
}

http {  

    fastcgi_buffer_size 32k;
    fastcgi_buffers 8 16k;
    fastcgi_connect_timeout 300;
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;  

    server {
        listen 80; 
        server_name kundol 
    }

    location / {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;
        proxy_pass http://127.0.0.1:12010/;
        proxy_redirect off;
        gzip on; 
        gzip_comp_level 2; 
        gzip_min_length 1000; 
        gzip_disable "MISE [1-6]"
        gzip_type text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    }
}
```
1. `fastcgi`부분은 HTTP를 연결하는 블록을 의미하는데 이 때의 버퍼와 타임아웃을 의미한다. 
요청과부화가 걸릴 때 최대한 연결을 유지시키기 위해서 최대치로 설정해서 502 메세지를 막을 수 있습니다. 
2. `proxy_pass`는 그 후에 있는 서버로 프록시연결을 시킨다는 것입니다. 80포트로 접근하면 12010으로 연결되게끔 설계한 것입니다. 
3. `gzip_disable`은 gzip은 IE6이하는 지원되지 않기 떄문에 저렇게 설정합니다.
4. `error_log` nginx의 애러로그를 볼 수 있습니다. warn, 경고 수준의 로그만 기록하게끔 만들어 놨습니다. `tail -f /var/log/nginx/nginx_errors.log`로 조회할 수 있습니다. 

 > gzip : html, javascript, css 등을 압축해줘서 리소스를 받는 로딩시간을 줄여주어서 성능을 개선시켜 줍니다 하지만 Gzip을 압축하고 푸는데도 서버와 웹브라우저에 약간의 CPU가 쓰이게 되므로 통상적으로 1kb ~ 2kb 이하는 Gzip을 압축하지 않는것이 좋습니다. 



## nginx 명령어
1. 재시작
```shell
sudo service nginx reload
# 또는..
sudo service nginx restart
# 또는.. 
sudo /etc/init.d/nginx restart
```
  > 태그 : nginx